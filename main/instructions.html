
<!-- saved from url=(0040)https://samsclass.info/140/proj/pur1.htm -->
<html class="gr__samsclass_info"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>Purple 1: Drupal, Splunk, and Suricata</title>
</head>
<body bgcolor="#cccccc" style="font-family:Arial" data-gr-c-s-loaded="true">
<h1>Purple 1: Drupal, Splunk, and Suricata</h1>
<h2>What You Need for This Project</h2>
<ul>
<li>A computer with an Internet connection.
</li><li>A Google account and a credit card (which won't be charged)
</li></ul>
<hr>
<h1>Task 1: Create Cloud Servers (20 pts)</h1>
Make two Google Cloud machines, allowing
HTTP and HTTPS traffic, as shown below.
<p>
One machine is the <b><i>attacker</i></b>
running Debian 9, and the other is the
<b><i>target</i></b>
running Ubuntu 18.04.
</p><p>
Instructions are available here:
</p><p>
<b>
<a href="https://samsclass.info/123/proj14/p1cgc.htm">
https://samsclass.info/123/proj14/p1cgc.htm</a>
</b>
</p><p><img src="./instructions_files/rvb_drupal1.png"></p><p>
</p><p><img src="./instructions_files/rvb_drupal2.png"></p><p>
</p><h2>1.1: Record Your Success (10 pts)</h2>
On the Debian server, execute the <b>lshw</b>
command. The text covered by the green
box in the image below is the flag.
<p><img src="./instructions_files/rvb_drupal3.png"></p><p>
</p><h2>1.2: Record Your Success (10 pts)</h2>
On the Ubuntu server, execute these commands:
<blockquote><b><big><code><pre>sudo apt update
sudo apt install hwinfo
sudo hwinfo
</pre></code></big></b></blockquote>
Find the portion of the output shown below.
The text covered by the green
box in the image below is the flag.
<p><img src="./instructions_files/rvb_drupal4.png"></p><p>
</p><hr>
<h1>Task 2: Install Drupal 7.20 (20 pts)</h1>
<h2>Install Apache and MySQL</h2>
On the Ubuntu server, execute these commands,
one at a time, entering reasonable answers
to all the questions that appear.
<blockquote><b><big><code><pre>sudo apt-get install apache2
sudo apt-get install mysql-server mysql-client
sudo mysql_secure_installation
sudo systemctl start mysql.service
sudo mysql -u root -p
</pre></code></big></b></blockquote>
<h2>Create the Drupal Database</h2>
At the <b><big><code>mysql&gt;</code>,/big&gt;</big></b><big> prompt,
execute these commands:
<blockquote><b><big><code><pre>CREATE DATABASE drupal;
CREATE USER drupaluser@localhost IDENTIFIED BY 'password';

GRANT ALL ON drupal.* TO drupaluser@localhost;

FLUSH PRIVILEGES;
exit
</pre></code></big></b></blockquote>
<h2>Install PHP</h2>
On the Ubuntu server, execute these commands.
<blockquote><b><big><code><pre>sudo apt-get install php 
sudo apt-get install libapache2-mod-php php-mysql php-xml 
sudo apt-get install php-curl php-gd 
sudo apt-get install imagemagick 
sudo apt-get install php-recode php-tidy php-xmlrpc
</pre></code></big></b></blockquote>
<h2>Install Drupal</h2>
On the Ubuntu server, execute these commands.
<blockquote><b><big><code><pre>cd /tmp &amp;&amp; wget ftp.drupal.org/files/projects/drupal-7.26.tar.gz
tar xzvf drupal*
sudo mv drupal-7.26/* /var/www/html

cp /var/www/html/sites/default/default.settings.php /var/www/html/sites/default/settings.php

sudo rm /var/www/html/index.html

sudo chmod -R 755 /var/www/html/*
sudo chown -R www-data:www-data /var/www/html/*

sudo a2enmod rewrite
sudo a2enmod env
sudo a2enmod dir
sudo a2enmod mime
</pre></code></big></b></blockquote>
On the Ubuntu server, execute this command:
<blockquote><b><big><code><pre>sudo nano /etc/apache2/sites-enabled/000-default.conf
</pre></code></big></b></blockquote>
Remove all the contents and insert the code shown below.
<blockquote><b><big><code><pre>&lt;VirtualHost *:80&gt;

     ServerAdmin admin@example.com
     DocumentRoot /var/www/html/
     ServerName example.com
     ServerAlias www.example.com
     ErrorLog ${APACHE_LOG_DIR}/error.log
     CustomLog ${APACHE_LOG_DIR}/access.log combined

      &lt;Directory /var/www/html/&gt;
           Options FollowSymlinks
           AllowOverride All
           Require all granted
      &lt;/Directory&gt;
      &lt;Directory /var/www/html/&gt;
           RewriteEngine on
           RewriteBase /
           RewriteCond %{REQUEST_FILENAME} !-f
           RewriteCond %{REQUEST_FILENAME} !-d
           RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
      &lt;/Directory&gt;

&lt;/VirtualHost&gt;
</pre></code></big></b></blockquote>
Savee the file with <b>Ctrl+X</b>, <b>Y</b>,
Enter.
<p>
Execute this command to
restart Apache2:
</p><blockquote><b><big><code><pre>sudo systemctl restart apache2
</pre></code></big></b></blockquote>
<h2>Set Up Drupal</h2>
In the Google Cloud Platform console,
find the external IP address of your Drupal
server, as shown below.
<p><img src="./instructions_files/rvb_drupal5.png"></p><p>
In a Web browser, open this URL, adjusting the
IP address as necessary:
</p><blockquote><b><big><code><pre>http://34.73.73.12
</pre></code></big></b></blockquote>
The Drupal installation page opens,
as shown below.
<p><img src="./instructions_files/rvb_drupal7.png"></p><p>
Install Drupal with the default options.
You chose the Drupal database name, username,
and password earlier, after installing "MySQL".
</p><p>
<b><i>DON'T ALLOW UPDATES!</i></b>
</p><p>
We need to use an old, vulnerable version
of Drupal.
</p><p>
Your Drupal page appears,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal6.png"></p><p>
</p><h2>2: Record Your Success (20 pts)</h2>
At the top right of this page, click
<b>Reports</b>,
"<b>Status report</b>".
The text covered by the green
box in the image below is the flag.
<p><img src="./instructions_files/rvb_drupal8.png"></p><p>
</p><hr>
<h1>Task 3: Install Splunk</h1>
<h2>Getting the Download Link</h2>
In a Web browser, go to
<p><b>
<a href="https://www.splunk.com/">
https://www.splunk.com</a></b>
</p><p>
At the top right, click the tiny
head-and-shoulders icon,
outlined in aqua in the image below.
</p><p><img src="./instructions_files/rvb_drupal9.png"></p><p>
If you have a Splunk account, log in.
Otherwise create one now.
</p><p>
At the top right, click the green
"<b>Free Splunk</b>" button.
</p><p>
At the lower left of the next page, in
the "Splunk Enterprise" sectin, click
"<b>Download Free 60-Day Trial</b>",
as shown below.
</p><p><img src="./instructions_files/rvb_drupal10.png"></p><p>
On the next page, click the <b>Linux</b> tab,
and, in the ".deb" line, click the
"<b>Download Now</b>" button,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal11.png"></p><p>
On the next page, accept the agreement
and click the
"<b>Start Your Download Now</b>" button,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal12.png"></p><p>
When the download starts, cancel it.
At the top right of the next page,
click "<b>Command Line (wget)</b>".
</p><p>
Highlight the command in the pop-up box
and copy it,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal13.png"></p><p>
</p><h2>Installing the Software</h2>
On your Target Linux machine, in a terminal
window, execute the command you just copied.
The file downloads,
as shown below.
<p><img src="./instructions_files/rvb_drupal14.png"></p><p>

On the Ubuntu server, execute these commands.
</p><blockquote><b><big><code><pre>sudo dpkg -i splunk-7.2.5-088f49762779-linux-2.6-amd64.deb
cd /opt/splunk/bin
sudo ./splunk start
</pre></code></big></b></blockquote>
A license agreement fills the screen.
Press <b>Q</b> to close it.
<p>
Enter <b>y</b> to agree to the license.
Enter a username and password for Splunk.
</p><p>
Splunk installs,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal15.png"></p><p>
</p><h2>Viewing the Splunk Page</h2>
Open this URL, replacing the IP address
with the public IP address of your Drupal
server:
<blockquote><b><big><code><pre>http://34.73.73.12:8000
</pre></code></big></b></blockquote>
The page won't open, because the Google Cloud
firewall is blocking it.
<h2>Opening Port 8000</h2>
In the Google Cloud Platform page,
in the line for your Drupal server,
on the right side,
click the three-dot icon, and click
"<b>View network details</b>",
as shown below.
<p><img src="./instructions_files/rvb_drupal16.png"></p><p>
On the next page, on the left side,
click "<b>Firewall rules</b>".
</p><p>
At the top center, click
"<b>CREATE FIREWALL RULE</b>",
as shown below.
</p><p><img src="./instructions_files/rvb_drupal17.png"></p><p>
Add a new "ingress" rule allowing port 8000,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal18.png"></p><p>
Open the Splunk management page again.
It appears, as shown below.
</p><p><img src="./instructions_files/rvb_drupal21.png"></p><p>
Log in with the administrator credentials
you specified when installing Splunk,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal19.png"></p><p>
</p><h2>3: Record Your Success (15 pts)</h2>
In the Splunk management page,
at the too, click <b>Settings</b>,
"<b>Server settings</b>",
"<b>General settings</b>".
<p>
The text covered by the green
box in the image below is the flag.
</p><p><img src="./instructions_files/rvb_drupal20.png"></p><p>
</p><hr>
<h1>Task 4: Monitoring the Logs</h1>
In the Splunk administration page,
click "<b>Add Data</b>",
as shown below.
<p><img src="./instructions_files/rvb_drupal21.png"></p><p>
If a box pops up asking you to take
a tour, click <b>Skip</b>.
</p><p>
In the next page,
scroll down to the "Or get data
in with the following methods"
section, and click
<b>Monitor</b>,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal22.png"></p><p>
In the "Add Data" screen,
on the left side,
click "<b>Files &amp; Directories</b>".
</p><p>
On the right side, enter a
"File or Directory" of
</p><blockquote><b><big><code><pre>/var/log
</pre></code></big></b></blockquote>
as shown below.
<p><img src="./instructions_files/rvb_drupal23.png"></p><p>
At the top right, click the green
<b>Next</b> button.
</p><p>
Click <b>Review</b>.
Click <b>Submit</b>.
</p><p>
Click "<b>Start Searching</b>".
</p><p>
If a box pops up asking you to take
a tour, click <b>Skip</b>.
</p><p>
Splunk shows log entries,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal14.png"></p><p>
</p><h2>Finding Private IP Address</h2>
On your Drupal <b><i>target</i></b> server,
execute this command:
<blockquote><b><big><code><pre>ip a
</pre></code></big></b></blockquote>
Find your server's private IP address,
as highlighted in the image below.
<p><img src="./instructions_files/rvb_drupal25.png"></p><p>
</p><h2>Enabling Password Authentication</h2>
On your Drupal <b><i>target</i></b> server,
execute this command:
<blockquote><b><big><code><pre>sudo nano /etc/ssh/sshd_config
</pre></code></big></b></blockquote>
Enable password authentication,
as shown below.
<p><img src="./instructions_files/rvb_drupal26.png"></p><p>
Save the file with <b>Ctrl+X</b>,
<b>Y</b>, Enter.
</p><p>
Execute this command to restart
SSH:
</p><blockquote><b><big><code><pre>sudo systemctl restart ssh
</pre></code></big></b></blockquote>
<h2>Making Login Attempts</h2>
On your <b><i>attacker</i></b> server,
execute this command,
replacing the IP address
with the private IP address of your Drupal
server.
<blockquote><b><big><code><pre>ssh fred@10.142.0.4
</pre></code></big></b></blockquote>
Enter incorrect passwords several times,
as shown below.
<p><img src="./instructions_files/rvb_drupal28.png"></p><p>
</p><h2>Viewing Recent Events</h2>
In the Splunk management page,
at the top left, click
<b>splunk</b>. The main
Splunk page appears,
as shown below.
<p><img src="./instructions_files/rvb_drupal21.png"></p><p>
On the left side, click
"<b>Search &amp; Reporting</b>".
</p><p>
In the Search page, in the lower right,
click the "<b>Data Summary</b>"
button,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal29.png"></p><p>
A "Data Summary" box pops up,
as shown below.
</p><p>
Click the hostname of your server,
which appears in blue letters.
</p><p><img src="./instructions_files/rvb_drupal30.png"></p><p>
</p><h2>4: Record Your Success (10 pts)</h2>
In Splunk,
find a "Failed password" event for
"fred", as shown below.
<p>
The text covered by the green
box in the image below is the flag.
</p><p><img src="./instructions_files/rvb_drupal27.png"></p><p>
</p><hr>
<h1>Task 5: Install Suricata</h1>
<h2>Installing Suricata from a PPA Repository</h2>
On your Drupal <b><i>target</i></b> server,
execute these commands:
<blockquote><b><big><code><pre>sudo add-apt-repository ppa:oisf/suricata-stable
sudo apt update
sudo apt-get install suricata 
</pre></code></big></b></blockquote>
<h2>Configuring a Test Rule</h2>
On your Drupal <b><i>target</i></b> server,
execute this command:
<blockquote><b><big><code><pre>sudo nano /etc/suricata/rules/test-ddos.rules
</pre></code></big></b></blockquote>
Paste in the code below. This rule fires when there are
more than 10 attempted connections within one second.
<blockquote><b><big><code><pre>alert tcp any any -&gt; $HOME_NET 80 (msg: "Possible DDoS attack"; flags: S; flow: stateless; threshold: type both, track by_dst, count 20, seconds 1; sid:1000001; rev:1;)
</pre></code></big></b></blockquote>
Save the file with <b>Ctrl+X</b>, <b>Y</b>, Enter.
<p>
On your Drupal <b><i>target</i></b> server,
execute this command:
</p><blockquote><b><big><code><pre>sudo nano /etc/suricata/suricata.yaml
</pre></code></big></b></blockquote>
Press <b>Ctrl+W</b> and search for "<b>rule-files</b>".
<p>
Adjust the "default-rule-path" and insert a "Custom Test Rule",
as shown below.
</p><p><img src="./instructions_files/rvb_drupal37.png"></p><p>
Use <b>Ctrl+W</b> to find all references to "eth0"
and change them to "ens4"
</p><p>
Save the file with <b>Ctrl+X</b>, <b>Y</b>, Enter.
</p><h2>Start Suricata</h2>
On your Drupal <b><i>target</i></b> server,
execute these commands:
<blockquote><b><big><code><pre>sudo service suricata stop
sudo rm /var/run/suricata.pid
sudo suricata -D -c /etc/suricata/suricata.yaml -i ens4
</pre></code></big></b></blockquote>
<h2>Monitor the Suricata Log</h2>
On your Drupal <b><i>target</i></b> server,
execute this command:
<blockquote><b><big><code><pre>tail -f /var/log/suricata/fast.log
</pre></code></big></b></blockquote>
<h2>Perform a SYN FLOOD Attack</h2>
On the <b><i>attack</i></b> server,
execute these commands,
replacing the IP address in the second command with
the address of your Drupal server.
<blockquote><b><big><code><pre>sudo apt install hping3
sudo hping3 -c 20 -S -p 80 -i u10000  10.142.0.4
</pre></code></big></b></blockquote>
The packet flood runs,
as shown below.
<p><img src="./instructions_files/rvb_drupal38.png"></p><p>
</p><h2>5: Record Your Success (15 pts)</h2>
An alert appears on the target server.
<p>
The text covered by the green
box in the image below is the flag.
</p><p><img src="./instructions_files/rvb_drupal39.png"></p><p>
</p><hr>
<h1>Task 6: Updating Suricata Rules</h1>
<h2>Getting the Rules</h2>
On your Drupal <b><i>target</i></b> server,
execute this command:
<blockquote><b><big><code><pre>sudo suricata-update
</pre></code></big></b></blockquote>
This places a ruleset into the directory
highlighted in the image below:
<p><img src="./instructions_files/rvb_drupal40.png"></p><p>
</p><h2>Configurting Suricata to Use the New Rules</h2>
On your Drupal <b><i>target</i></b> server,
execute this command:
<blockquote><b><big><code><pre>sudo nano /etc/suricata/suricata.yaml
</pre></code></big></b></blockquote>
Press <b>Ctrl+W</b> and search for "<b>rule-files</b>".
<p>
Adjust the "default-rule-path" and comment out the "Custom Test Rule",
as shown below.
</p><p><img src="./instructions_files/rvb_drupal41.png"></p><p>
Save the file with <b>Ctrl+X</b>, <b>Y</b>, Enter.
</p><h2>Restarting Suricata</h2>
On your Drupal <b><i>target</i></b> server,
execute these commands:
<blockquote><b><big><code><pre>sudo service suricata stop
sudo rm /var/run/suricata.pid
sudo suricata -D -c /etc/suricata/suricata.yaml -i ens4
</pre></code></big></b></blockquote>
<h2>Viewing Suricata Alerts in Splunk</h2>
In your Splunk page,
at the top left, click
<b>splunk&gt;</b>
<p>
On the left side, click
"<b>Search &amp; Reporting</b>".
</p><p>
In the lower center, click the
"<b>Data Summary</b>" button.
</p><p>
In the "Data Summary" box, click the
<b>Sources</b> tab.
Several Suricata files appear,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal42.png"></p><p>
Click <b>/var/log/suricata/fast.log</b>.
</p><p>
The alert you saw previously appears in
Splunk,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal43.png"></p><p>
</p><h2>Perform Another SYN FLOOD Attack</h2>
On the <b><i>attack</i></b> server,
execute this command,
replacing the IP address in the second command with
the address of your Drupal server.
<blockquote><b><big><code><pre>sudo hping3 -c 20 -S -p 80 -i u10000 10.142.0.4
</pre></code></big></b></blockquote>
<h2>Viewing the Suricata Alert in Splunk</h2>
In Splunk, at the top right,
click the
<b>green magnifying glass button</b>.
<p>
</p><h2>6: Record Your Success (10 pts)</h2>
An alert appears, as shown below.
<p>
The text covered by the green
box in the image below is the flag.
</p><p><img src="./instructions_files/rvb_drupal44.png"></p><p>
</p><hr>
<h2>References</h2>
<a href="https://websiteforstudents.com/install-drupal-cms-ubuntu-17-04-17-10/">
How to Install Drupal CMS on Ubuntu 17.04 / 17.10</a><br>
<a href="https://github.com/MKorostoff/drupalgeddon/blob/master/attack/exploit.php">
MKorostoff/drupalgeddon</a><br>
<a href="https://kifarunix.com/install-and-setup-suricata-on-ubuntu-18-04/">
Install and Setup Suricata on Ubuntu 18.04</a><br>
<p>
Posted 3-21-19 <br>
</p><p>
</p></big></body></html>