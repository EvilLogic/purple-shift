
<!-- saved from url=(0040)https://samsclass.info/140/proj/pur2.htm -->
<html class="gr__samsclass_info"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>Purple Competion 2: Drupal, Splunk, and Suricata</title>
</head>
<body bgcolor="#cccccc" style="font-family:Arial" data-gr-c-s-loaded="true">
<h1 align="center">Purple Competition #2</h1>
<hr>
<h2>What You Need for This Project</h2>
<ul>
<li>A computer with an Internet connection.
</li><li>A Google account and a credit card (which won't be charged)
</li></ul>
<h2>Purpose</h2>
Practice using Google Cloud, Suricata, Splunk, Metasploit, and
custom exploits in Python and Ruby.
<hr>
<h1>Task 1: Creating Cloud Servers</h1>
<h2>Creating a Google Cloud Debian Server</h2>
If you made a Google Cloud Debian server
previously, use that.
<p>
If you did not, follow these instructions:
</p><p>
<a href="https://samsclass.info/140/proj/gclprep.htm"><b>
Google Cloud Preparation</b></a>
</p><h2>Creating an Image</h2>
First, you need to create a disk
image from my public image, which
is stored on the Google Cloud.
<p>
In Google Cloud Platform,
on the left side, click
"<b>Compute Engine</b>",
<b>Images</b>,
as shown below.
</p><p><img src="./instructions_files/pur2-9.png"></p><p>
At the top center of the next
page,
click
"<b>CREATE IMAGE</b>",
as shown below.
</p><p><img src="./instructions_files/pur2-10.png"></p><p>
As shown below,
create an image using a
Source of "<b>Cloud Storage file</b>"
and a Cloud Storage file of:
</p><blockquote><b><big><code><pre>gs://samsimages/purple1.tar.gz
</pre></code></big></b></blockquote>
Click
<b>Create</b>. This took 5 minutes when
I did it.
<p><img src="./instructions_files/pur2-10.png"></p><p>
When the process finishes, your
image appears in the Images list,
as shown below.
</p><p><img src="./instructions_files/pur2-12.png"></p><p>
</p><h2>Creating the Target Server</h2>
At the top left, click
"<b>VM instances</b>".
<p>
In the top center, click
"<b>CREATE INSTANCE</b>".
</p><p>
In the "Boot disk" section, click the
<b>Change</b> button,
as shown below.
</p><p><img src="./instructions_files/pur2-6.png"></p><p>
In the "Boot disk" box,
on the "<b>Custom images</b>"
tab, select <b>purple1</b>,
as shown below.
</p><p>
Click <b>Select</b>.
</p><p><img src="./instructions_files/pur2-5.png"></p><p>
In the Firewall section, allow both
HTTP and HTTPS traffic,
as shown below.
</p><p>
Click <b>Create</b>.
</p><p><img src="./instructions_files/pur2-7.png"></p><p>
When your server is created, it
appears in the
"VM instances"
list,
as shown below.
</p><p><img src="./instructions_files/pur2-13.png"></p><p>
</p><h2>Testing Drupal</h2>
Find the "External IP" of your
target server, as shown in the
image above.
<p>
In a Web browser, open this URL,
replacing the IP address with the
correct address of your target
server.
</p><blockquote><b><big><code><pre>http://35.236.41.106
</pre></code></big></b></blockquote>
You should see a Drupal page,
as shown below.
<p><img src="./instructions_files/pur2-14.png"></p><p>
</p><h2>Starting Splunk</h2>
In the
"VM instances"
list, on the right side,
on the line for your target server,
click <b>SSH</b> to open a Terminal.
<p>
In the Terminal, execute this
command to start Splunk:
</p><blockquote><b><big><code><pre>sudo /opt/splunk/bin/splunk start
</pre></code></big></b></blockquote>
Splunk starts,
as shown below.
<p><img src="./instructions_files/pur2-15.png"></p><p>
</p><h2>Starting Suricata</h2>
On your Drupal <b><i>target</i></b> server,
execute these commands:
<blockquote><b><big><code><pre>sudo service suricata stop
sudo rm /var/run/suricata.pid
sudo suricata -D -c /etc/suricata/suricata.yaml -i ens4
</pre></code></big></b></blockquote>
<h2>Testing Splunk</h2>
In a Web browser, open this URL,
replacing the IP address with the
correct address of your target
server.
<p>
<i><b>Note that this page uses port 443,
but it does NOT use HTTPS.</b></i>
</p><p>
</p><blockquote><b><big><code><pre>http://35.236.41.106:443
</pre></code></big></b></blockquote>
You see the Splunk login page,
as shown below.
<p><img src="./instructions_files/pur2-16.png"></p><p>
Log in with these credentials:
</p><ul>
<li>Username: <b>password</b>
</li><li>Password: <b>P@ssw0rd</b>
</li></ul>
You see the Splunk home page,
as shown below.
<p><img src="./instructions_files/pur2-17.png"></p><p>
</p><h2>Testing Connectivity</h2>
In the
"VM instances"
list, on the right side,
on the line for your Debian attack server,
click <b>SSH</b> to open a Terminal.
<p>
In the Terminal, execute this
command, replacing the IP address
with the IP address of your
target Drupal server:
</p><blockquote><b><big><code><pre>ping -c 2 35.236.41.106
</pre></code></big></b></blockquote>
You should see replies,
as shown below.
<p><img src="./instructions_files/pur2-18.png"></p><p>

</p><h2>Sending Suspicious Traffic</h2>
In the
"VM instances"
list, on the right side,
on the line for your Debian attack server,
click <b>SSH</b> to open a Terminal.
<p>
In the Terminal, execute this
command, replacing the IP address
with the IP address of your
target Drupal server:
</p><blockquote><b><big><code><pre>curl -A "Hentai" 35.236.41.106
</pre></code></big></b></blockquote>
The source code for the main Web page
loads, beginning with the HTML code
shown below, and scrolling down for a few
screens.
<p><img src="./instructions_files/pur2-19.png"></p><p>
</p><h2>Viewing the Suricata Alert in Splunk</h2>
In your Splunk page,
at the top left, click
<b>splunk&gt;</b>
<p>
On the left side, click
"<b>Search &amp; Reporting</b>".
</p><p>
In the lower center, click the
"<b>Data Summary</b>" button.
</p><p>
In the "Data Summary" box, click the
<b>Sources</b> tab.
Several source files appear,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal42.png"></p><p>
In the "filter" box, enter
<b>sur</b>
</p><p>
Several Suricata files appear,
as shown below.
</p><p><img src="./instructions_files/rvb_drupal45.png"></p><p>
Click <b>/var/log/suricata/fast.log</b>.
</p><p>
You see an alert containing "Hentai",
as shown below.
</p><p><img src="./instructions_files/pur2-20.png"></p><p>
</p><h2>Flag 1: "Hentai" Alert (20 pts)</h2>
The flag is the text covered by a green
box in the image above. Enter that flag
into the scoring engine to record your success.
<hr>
<h1>Task 2: Protecting Your Server</h1>
The vulnerable Drupal server will get hacked
before long by automated attacks.
<p>
To prevent that, we'll configure the Google
Cloud firewall to restrict access to
only trusted IP addresses.
</p><h2>Finding your Public IP Address</h2>
In Google, search for
<p><b>
whats my ip
</b></p><p>
Your public IP appears,
as shown below.
</p><p>
Make a note of it.
</p><p><img src="./instructions_files/pur2-23.png"></p><p>
</p><h2>Adjusting the Firewall</h2>
In the Google Cloud Platform page,
in the line for your Drupal server,
on the right side,
click the three-dot icon, and click
"<b>View network details</b>",
as shown below.
<p><img src="./instructions_files/pur2-21.png"></p><p>
On the next page, on the left side,
click "<b>Firewall rules</b>".
</p><p>
In the list of rules, click
<b>default-allow-http</b>,
as shown below.
</p><p><img src="./instructions_files/pur2-22.png"></p><p>
In the "Firewall rule details"
page, at the top center, click
<b>EDIT</b>.
</p><p>
Adjust the Source IP range to only include the IP
of your Drupal attack server, and the
public IP
of your own computer,
as shown below.
</p><p><img src="./instructions_files/pur2-24.png"></p><p>
At the bottom of the page,
click <b>Save</b>.
</p><p>
</p><h2>Flag 2: Firewall Rule (5 pts)</h2>
The flag is the text covered by a green
box in the image above. Enter that flag
into the scoring engine to record your success.
<hr>
<h1>Task 3: Drupalgeddon Attack</h1>
On your Debian attack server,
copy code from this page into a file named "dru":
<p><b>
<a href="https://github.com/kenorb/drupageddon/blob/master/drupal_7.x_sql_injection_sa-core-2014-005.py">
https://github.com/kenorb/drupageddon/blob/master/drupal_7.x_sql_injection_sa-core-2014-005.py
</a></b>
</p><p>
Then copy code from this page into a file named "drupalpass.py":
</p><p><b>
<a href="https://github.com/cvangysel/gitexd-drupalorg/blob/master/drupalorg/drupalpass.py">
https://github.com/cvangysel/gitexd-drupalorg/blob/master/drupalorg/drupalpass.py
</a></b>
</p><p>
Use <b>chmod</b> to make "dru" executable and send some attacks to your
target server,
as shown below.
</p><p><img src="./instructions_files/pur2-26.png"></p><p>
</p><h2>Detecting the Attack</h2>
In Splunk, find the Suricata alert shown below.
<p><img src="./instructions_files/pur2-25.png"></p><p>
</p><h2>Flag 3: Drupalgeddon Alert (10 pts)</h2>
The flag is the text covered by a green
box in the image above. Enter that flag
into the scoring engine to record your success.
<hr>
<h1>Task 4: Drupalgeddon 2 Attack</h1>
On your Debian attack server,
use this attack to exploit your target:
<p><b>
<a href="https://github.com/dreadlocked/Drupalgeddon2">
https://github.com/dreadlocked/Drupalgeddon2
</a></b>
</p><p>
You will have to install Ruby and resolve a missing dependency.
</p><p>
Attack your
target server,
as shown below.
</p><p><img src="./instructions_files/pur2-27.png"></p><p>
</p><h2>Recording Your Success</h2>
In Splunk, find the Suricata alert shown below.
The flag is the text covered by a green
box. Enter that flag
into the scoring engine to record your success.
<p><img src="./instructions_files/pur2-28.png"></p><p>
</p><h2>Flag 4: Drupalgeddon 2 Alert (20 pts)</h2>
The flag is the text covered by a green
box in the image above. Enter that flag
into the scoring engine to record your success.
<hr>
<h1>Task 5: Resizing your Disk</h1>
To add more Splunk modules, we'll need a larger
hard disk.
<p>
On the purple1 machine, in an SSH session,
execute these commands to see the current disk
space and begin a proper shutdown:
</p><blockquote><b><big><code><pre>df -h
sudo halt
</pre></code></big></b></blockquote>
<p><img src="./instructions_files/pur2-30.png"></p><p>
If it's taking too long, which it did for me,
force a shutdown from the "VM instances"
page:
</p><p><img src="./instructions_files/pur2-31.png"></p><p>
In Google Cloud Platform, on the left side, click
"<b>Compute Engine</b>", <b>Disks</b>.
</p><p>
Click on the <b>purple1</b> disk, and then, at the top, on
<b>EDIT</b>.
</p><p>
Cchange the disk size from 10 to 20 GB,
as shown below.
</p><p><img src="./instructions_files/pur2-32.png"></p><p>
</p><h2>Flag 5: Disk Type (10 pts)</h2>
The flag is the text covered by a green
box in the image above. Enter that flag
into the scoring engine to record your success.
<h2>Restarting your Server</h2>
In Google Cloud Platform,
start the purple1 server.
<p>
Run the <b>df -h</b> command
and verify that the disk has more space,
as shown below.
</p><p><img src="./instructions_files/pur2-33.png"></p><p>
</p><h2>Restarting Suricata and Splunk</h2>
Restart Suricata and Splunk.
<hr>
<h1>Task 6: Adding Splunk Stream</h1>
Go here:
<p><b>
<a href="https://splunkbase.splunk.com/app/1809/">
https://splunkbase.splunk.com/app/1809/</a>
</b>
</p><p>
Log in to a Splunk account. Download the <b>splunk-stream_712.tgz</b> file.
</p><p>
At the top left of Splunk, click "<b>splunk&gt;</b>"
</p><p>
At the top left , click the gear icon.
The Apps page opens,
as shown below.
</p><p><img src="./instructions_files/pur2-29.png"></p><p>
At the top right, click
"<b>Install app from file</b>".
</p><p>
Click "<b>Choose File</b> and browse to the
<b>splunk-stream_712.tgz</b> file.
</p><p>
Click <b>Upload</b>.
</p><p>
After a few minutes, you are prompted to restart Splunk.
Do that.
</p><p>
Now Splunk has stream data,
as shown below.
</p><p><img src="./instructions_files/pur2-34.png"></p><p>
</p><h2>Flag 6: Splunk Stream (10 pts)</h2>
The flag is the text covered by a green
box in the image above. Enter that flag
into the scoring engine to record your success.
<hr>
<h1>Task 7: Installing Metasploit</h1>
Install Metasploit on your Debian attack server, as explained here:
<p><b>
<a href="https://computingforgeeks.com/how-to-install-metasploit-framework-on-ubuntu-18-04-debian-9/">
https://computingforgeeks.com/how-to-install-metasploit-framework-on-ubuntu-18-04-debian-9/</a>
</b></p><p>
Execute these commands to start Metasploit and search for drupal attacks:
</p><blockquote><b><big><code><pre>msfconsole
search splunk
</pre></code></big></b></blockquote>
Drupalgeddon and drupalgeddon2 are both available,
as shown below.
<p><img src="./instructions_files/pur2-35.png"></p><p>
</p><h2>Flag 7: Metasploit (10 pts)</h2>
The flag is the text covered by a green
box in the image above. Enter that flag
into the scoring engine to record your success.
<hr>
<h1>Task 8: Drupalgeddon via Metasploit</h1>
Use Metasploit to perform a Drupalgeddon attack,
as shown below.
<p><img src="./instructions_files/pur2-36.png"></p><p>
In the meterpreter session, execute these commands:
</p><blockquote><b><big><code><pre>shell
curl http://ad.samsclass.info
</pre></code></big></b></blockquote>
In Splunk, search for
<blockquote><b><big><code><pre>ad.samsclass.info
</pre></code></big></b></blockquote>
as shown below.
<p><img src="./instructions_files/pur2-37.png"></p><p>
</p><h2>Flag 8: Source (10 pts)</h2>
The flag is the text covered by a green
box in the image above. Enter that flag
into the scoring engine to record your success.
<p>
Posted 4-13-19 <br>
</p><p>
</p></body></html>